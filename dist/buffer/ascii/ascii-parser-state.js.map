{"version":3,"file":"ascii-parser-state.js","sourceRoot":"","sources":["../../../src/buffer/ascii/ascii-parser-state.ts"],"names":[],"mappings":"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","sourcesContent":["import { Tags } from '../tags'\r\nimport { MessageDefinition } from '../../dictionary'\r\nimport { ElasticBuffer } from '../elastic-buffer'\r\n\r\nexport enum ParseState {\r\n  BeginField = 1,\r\n  ParsingTag = 2,\r\n  ParsingValue = 3,\r\n  ParsingRawDataLength = 4,\r\n  ParsingRawData = 5,\r\n  MsgComplete = 6\r\n}\r\n\r\nexport class AsciiParserState {\r\n  public message: MessageDefinition\r\n  public locations: Tags\r\n  public parseState: ParseState\r\n  public bodyLen: number\r\n  public checksumExpectedPos: number\r\n  public tagStartPos: number\r\n  public equalPos: number\r\n  public valueEndPos: number\r\n  public count: number\r\n  public currentTag: number\r\n  public rawDataLen: number\r\n  public rawDataRead: number\r\n  public msgType: string\r\n\r\n  constructor (public readonly elasticBuffer: ElasticBuffer) {\r\n  }\r\n\r\n  public beginTag (pos: number) {\r\n    this.parseState = ParseState.ParsingTag\r\n    this.tagStartPos = pos\r\n    this.equalPos = this.valueEndPos = -1\r\n    this.currentTag = 0\r\n  }\r\n\r\n  public endTag (pos: number): void {\r\n    this.equalPos = pos\r\n    const state = this.parseState\r\n    switch (state) {\r\n      case ParseState.ParsingTag: {\r\n        this.currentTag = this.elasticBuffer.getWholeNumber(this.tagStartPos, pos - 1)\r\n        break\r\n      }\r\n\r\n      default:\r\n        throw new Error(`EndTag: unexpected state ${state}`)\r\n    }\r\n    // if a raw tag, then need length to skip that many bytes\r\n    this.checkRawTag()\r\n  }\r\n\r\n  public incRaw (): boolean {\r\n    ++this.rawDataRead\r\n    return this.rawDataRead === this.rawDataLen + 1\r\n  }\r\n\r\n  public checkRawTag (): void {\r\n    const msg = this.message\r\n    if (!msg || !msg.containsRaw) {\r\n      // optimisation as will never hit raw data\r\n      this.parseState = ParseState.ParsingValue\r\n      return\r\n    }\r\n    // if this is a raw data tag then need to keep track of the length\r\n    // on this field to skip that many bytes.\r\n    const isDataLength: boolean = msg.containedLength[this.currentTag]\r\n    if (isDataLength) {\r\n      this.parseState = ParseState.ParsingRawDataLength\r\n    } else {\r\n      this.rawDataRead = 0\r\n      const isData: boolean = this.rawDataLen > 0\r\n      if (isData) {\r\n        this.parseState = ParseState.ParsingRawData\r\n      } else {\r\n        this.parseState = ParseState.ParsingValue\r\n      }\r\n    }\r\n  }\r\n\r\n  public store (): void {\r\n    const valueEndPos: number = this.elasticBuffer.getPos() - 1\r\n    this.valueEndPos = valueEndPos\r\n    const equalPos: number = this.equalPos\r\n    const tag: number = this.currentTag\r\n    const locations: Tags = this.locations\r\n    const buffer = this.elasticBuffer\r\n    const terminates = this.checksumExpectedPos\r\n\r\n    switch (this.parseState) {\r\n      case ParseState.ParsingValue:\r\n      case ParseState.ParsingRawData: {\r\n        this.rawDataLen = 0\r\n        locations.store(equalPos + 1, valueEndPos - equalPos - 1, tag)\r\n        break\r\n      }\r\n\r\n      case ParseState.ParsingRawDataLength: {\r\n        this.rawDataLen = buffer.getWholeNumber(equalPos + 1, valueEndPos - 1)\r\n        locations.store(equalPos + 1, valueEndPos - equalPos - 1, tag)\r\n        break\r\n      }\r\n    }\r\n\r\n    this.parseState = ParseState.BeginField\r\n    this.count++\r\n    const nextTagPos = locations.nextTagPos\r\n\r\n    switch (tag) {\r\n      case Tags.BeginString: {\r\n        if (nextTagPos !== 1) {\r\n          throw new Error(`BeginString: not expected at position [${nextTagPos}]`)\r\n        }\r\n        break\r\n      }\r\n\r\n      case Tags.BodyLengthTag: {\r\n        if (nextTagPos !== 2) {\r\n          throw new Error(`BodyLengthTag: not expected at position [${nextTagPos}]`)\r\n        }\r\n        this.bodyLen = buffer.getWholeNumber(equalPos + 1, valueEndPos - 1)\r\n        this.checksumExpectedPos = this.bodyLen + valueEndPos\r\n        this.elasticBuffer.checkGrowBuffer(this.bodyLen)\r\n        break\r\n      }\r\n\r\n      case Tags.MsgTag: {\r\n        if (nextTagPos !== 3) {\r\n          throw new Error(`MsgTag: not expected at position [${nextTagPos}]`)\r\n        }\r\n        this.msgType = buffer.getString(equalPos + 1, valueEndPos)\r\n        this.message = locations.definitions.message.get(this.msgType)\r\n        break\r\n      }\r\n\r\n      case Tags.CheckSumTag: {\r\n        if (valueEndPos < this.bodyLen) {\r\n          throw new Error(`CheckSumTag: [${valueEndPos}] expected after ${this.bodyLen}`)\r\n        }\r\n        this.parseState = ParseState.MsgComplete\r\n        break\r\n      }\r\n\r\n      default: {\r\n        if (terminates && valueEndPos > terminates) {\r\n          throw new Error(`Tag: [${tag}] cant be after ${terminates}`)\r\n        }\r\n        break\r\n      }\r\n    }\r\n\r\n    switch (nextTagPos) {\r\n      case 1: {\r\n        if (tag !== Tags.BeginString) {\r\n          throw new Error(`position 1 [${tag}] must be BeginString: 8=`)\r\n        }\r\n        break\r\n      }\r\n      case 2: {\r\n        if (tag !== Tags.BodyLengthTag) {\r\n          throw new Error(`position 2 [${tag}] must be BodyLengthTag: 9=`)\r\n        }\r\n        break\r\n      }\r\n      case 3: {\r\n        if (tag !== Tags.MsgTag) {\r\n          throw new Error(`position 3 [${tag}] must be MsgTag: 35=`)\r\n        }\r\n        break\r\n      }\r\n    }\r\n  }\r\n\r\n  public beginMessage (): void {\r\n    this.elasticBuffer.reset()\r\n    this.locations.reset()\r\n    this.checksumExpectedPos = 0\r\n    this.parseState = ParseState.BeginField\r\n    this.count = 0\r\n    this.currentTag = 0\r\n    this.tagStartPos = 0\r\n    this.valueEndPos = 0\r\n    this.equalPos = 0\r\n    this.rawDataRead = 0\r\n    this.rawDataLen = 0\r\n    this.bodyLen = 0\r\n    this.message = null\r\n    this.msgType = null\r\n  }\r\n}\r\n"]}