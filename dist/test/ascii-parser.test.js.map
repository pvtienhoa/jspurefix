{"version":3,"file":"ascii-parser.test.js","sourceRoot":"","sources":["../../src/test/ascii-parser.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { TagPos, SegmentType, MsgView, AsciiChars, AsciiParser } from '../buffer'\r\nimport { FixDefinitions } from '../dictionary'\r\nimport { JsonHelper, getDefinitions } from '../util'\r\nimport { ISessionDescription, StringDuplex } from '../transport'\r\nimport * as path from 'path'\r\n\r\nlet definitions: FixDefinitions\r\nlet jsonHelper: JsonHelper\r\nconst root: string = path.join(__dirname, '../../data')\r\nconst logon: string = '8=FIX4.4|9=0000208|35=A|49=sender-10|56=target-20|34=1|57=sub-a|52=20180610-10:39:01.621|98=2|108=62441|95=20|96=VgfoSqo56NqSVI1fLdlI|141=Y|789=4886|383=20|384=1|372=ipsum|385=R|464=N|553=sit|554=consectetur|10=49|'\r\nconst expectedTagPos = [\r\n  new TagPos(0, 8, 2, 6),\r\n  new TagPos(1, 9, 11, 7),\r\n  new TagPos(2, 35, 22, 1),\r\n  new TagPos(3, 49, 27, 9),\r\n  new TagPos(4, 56, 40, 9),\r\n  new TagPos(5, 34, 53, 1),\r\n  new TagPos(6, 57, 58, 5),\r\n  new TagPos(7, 52, 67, 21),\r\n  new TagPos(8, 98, 92, 1),\r\n  new TagPos(9, 108, 98, 5),\r\n  new TagPos(10, 95, 107, 2),\r\n  new TagPos(11, 96, 113, 20),\r\n  new TagPos(12, 141, 138, 1),\r\n  new TagPos(13, 789, 144, 4),\r\n  new TagPos(14, 383, 153, 2),\r\n  new TagPos(15, 384, 160, 1),\r\n  new TagPos(16, 372, 166, 5),\r\n  new TagPos(17, 385, 176, 1),\r\n  new TagPos(18, 464, 182, 1),\r\n  new TagPos(19, 553, 188, 3),\r\n  new TagPos(20, 554, 196, 11),\r\n  new TagPos(21, 10, 211, 2)]\r\n\r\nbeforeAll(async () => {\r\n  expect.assertions(1)\r\n  const sessionDescription: ISessionDescription = require(path.join(root, 'session/test-initiator.json'))\r\n  definitions = await getDefinitions(sessionDescription.application.dictionary)\r\n  jsonHelper = new JsonHelper(definitions)\r\n}, 45000)\r\n\r\nclass ParsingResult {\r\n  constructor (public readonly event: string, public readonly msgType: string, public readonly view: MsgView,\r\n               public readonly contents: string, public readonly parser: AsciiParser) {\r\n  }\r\n}\r\n\r\nfunction toParse (text: string, chunks: boolean = false): Promise<ParsingResult> {\r\n  return new Promise<any>((resolve, reject) => {\r\n    const parser = new AsciiParser(definitions, new StringDuplex(text, chunks).readable, AsciiChars.Pipe)\r\n    parser.on('error', (e: Error) => {\r\n      reject(e)\r\n    })\r\n    parser.on('msg', (msgType: string, view: MsgView) => {\r\n      resolve(new ParsingResult('msg', msgType, view.clone(), parser.state.elasticBuffer.toString(), parser))\r\n    })\r\n    parser.on('done', () => {\r\n      resolve(new ParsingResult('done', null,null, parser.state.elasticBuffer.toString(), parser))\r\n    })\r\n  })\r\n}\r\n\r\ntest('begin string incorrectly placed', () => {\r\n  return expect(toParse('8=FIX4.4|8=FIX4.4|')).rejects.toEqual(\r\n    new Error('BeginString: not expected at position [2]')\r\n  )\r\n})\r\n\r\ntest('body length incorrectly placed', () => {\r\n  return expect(toParse('8=FIX4.4|9=101|9=101|')).rejects.toEqual(\r\n    new Error('BodyLengthTag: not expected at position [3]')\r\n  )\r\n})\r\n\r\ntest('msg type incorrectly placed', () => {\r\n  return expect(toParse('8=FIX4.4|9=101|35=A|35=A|')).rejects.toEqual(\r\n    new Error('MsgTag: not expected at position [4]')\r\n  )\r\n})\r\n\r\ntest('do not start with 8=', () => {\r\n  return expect(toParse('59=FIX4.4|')).rejects.toEqual(\r\n    new Error('position 1 [59] must be BeginString: 8=')\r\n  )\r\n})\r\n\r\ntest('body length incorrectly placed', () => {\r\n  return expect(toParse('8=FIX4.4|59=101|9=101|')).rejects.toEqual(\r\n    new Error('position 2 [59] must be BodyLengthTag: 9=')\r\n  )\r\n})\r\n\r\ntest('msgTag incorrectly placed', () => {\r\n  return expect(toParse('8=FIX4.4|9=101|59=A|')).rejects.toEqual(\r\n    new Error('position 3 [59] must be MsgTag: 35=')\r\n  )\r\n})\r\n\r\ntest('first 3 fields correctly placed', async () => {\r\n  const res: ParsingResult = await toParse('8=FIX4.4|9=101|35=A|')\r\n  expect(res.event).toEqual('done')\r\n})\r\n\r\ntest('complete msg parsed', async () => {\r\n  const res: ParsingResult = await toParse(logon)\r\n  expect(res.event).toEqual('msg')\r\n  expect(res.msgType).toEqual('A')\r\n})\r\n\r\ntest('complete msg in chunks parsed', async () => {\r\n  const res: ParsingResult = await toParse(logon, true)\r\n  expect(res.event).toEqual('msg')\r\n  expect(res.msgType).toEqual('A')\r\n})\r\n\r\ntest('msg sent in chunks matches parser buffer', async () => {\r\n  const res: ParsingResult = await toParse(logon, true)\r\n  expect(res.msgType).toEqual('A')\r\n  expect(res.contents).toEqual(logon)\r\n})\r\n\r\ntest('logon parsers to correct tag set', async () => {\r\n  const res: ParsingResult = await toParse(logon, true)\r\n  expect(res.msgType).toEqual('A')\r\n  expect(res.view.structure.tags.tagPos).toEqual(expectedTagPos)\r\n})\r\n\r\ntest('tags other than 10 past body length', async () => {\r\n  const begin = '8=FIX4.4|9=0000208|'\r\n  const changed = logon.replace('10=49|','555=you know nothin|10=49')\r\n  return expect(toParse(changed)).rejects.toEqual(\r\n    new Error(`Tag: [555] cant be after ${208 + begin.length - 1}`)\r\n  )\r\n})\r\n\r\ntest('unknown message type', async () => {\r\n  const changed = logon.replace('35=A', '35=ZZ')\r\n  const res = await toParse(changed)\r\n  expect(res.view).toBeTruthy()\r\n  expect(res.view.segment.type).toEqual(SegmentType.Unknown)\r\n})\r\n\r\ntest('missing 1 required tag', async () => {\r\n  const changed = logon.replace('108=62441|','000=62441|')\r\n  const res = await toParse(changed)\r\n  expect(res.view).toBeTruthy()\r\n  const missing = res.view.missing()\r\n  expect(missing).toEqual([108])\r\n})\r\n\r\ntest('missing 2 required tags', async () => {\r\n  // const changed = logon.replace('108=62441|','000=62441|')\r\n  const changed = logon.replace('98=2|108=62441|','01=2|000=62441|')\r\n  const res = await toParse(changed)\r\n  expect(res.view).toBeTruthy()\r\n  const missing = res.view.missing()\r\n  expect(missing).toEqual([98, 108])\r\n})\r\n"]}