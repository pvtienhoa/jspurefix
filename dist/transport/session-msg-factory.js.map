{"version":3,"file":"session-msg-factory.js","sourceRoot":"","sources":["../../src/transport/session-msg-factory.ts"],"names":[],"mappings":"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","sourcesContent":["import { ISessionMsgFactory } from './fix-msg-factory'\r\nimport { ISessionDescription } from './session-description'\r\nimport { ILooseObject } from '../collections/collection'\r\nimport { MsgType } from '../types/enum'\r\n\r\nimport { ILogon, ITestRequest, IHeartbeat, ILogout,\r\n  IResendRequest, ISequenceReset, IReject, IStandardHeader, IStandardTrailer, EncryptMethod } from '../types/FIX4.4/repo'\r\n\r\nimport { IUserRequest, IUserResponse, UserRequestType, UserStatus, IStandardHeader as IStandardHeaderFixml } from '../types/FIXML50SP2'\r\n\r\nexport interface ObjectMutator { (description: ISessionDescription, type: string, o: ILooseObject): ILooseObject\r\n}\r\n\r\nexport class SessionMsgFactory implements ISessionMsgFactory {\r\n\r\n  public isAscii: boolean\r\n\r\n  constructor (public readonly description: ISessionDescription, public mutator: ObjectMutator = null) {\r\n    this.isAscii = description.application.protocol === 'ascii'\r\n  }\r\n\r\n  public reject (msgType: string, seqNo: number, msg: string, reason: number): ILooseObject {\r\n    const o: IReject = {\r\n      RefMsgType: msgType,\r\n      SessionRejectReason: reason,\r\n      RefSeqNum: seqNo,\r\n      Text: msg\r\n    } as IReject\r\n    return this.mutator ? this.mutator(this.description, MsgType.Reject, o) : o\r\n  }\r\n\r\n  public logon (userRequestId: string = '', isResponse: boolean = false): ILooseObject {\r\n    if (this.isAscii) {\r\n      return this.asciiLogon()\r\n    } else {\r\n      return this.fixmlLogon(userRequestId, isResponse)\r\n    }\r\n  }\r\n\r\n  public logout (msgType: string, text: string): ILooseObject {\r\n    if (this.isAscii) {\r\n      return this.asciiLogout(text)\r\n    } else {\r\n      return this.fixmlLogout(text, msgType !== 'UserReq')\r\n    }\r\n  }\r\n\r\n  public testRequest (reqId: string = `ping-${new Date().toUTCString()}`): ILooseObject {\r\n    const o: ITestRequest = {\r\n      TestReqID: reqId\r\n    } as ITestRequest\r\n    return this.mutator ? this.mutator(this.description, MsgType.TestRequest, o) : o\r\n  }\r\n\r\n  public heartbeat (testReqId: string): ILooseObject {\r\n    const o: IHeartbeat = {\r\n      TestReqID: testReqId\r\n    } as IHeartbeat\r\n    return this.mutator ? this.mutator(this.description, MsgType.Heartbeat, o) : o\r\n  }\r\n\r\n  public resendRequest (from: number, to: number): ILooseObject {\r\n    const o: IResendRequest = {\r\n      BeginSeqNo: from,\r\n      EndSeqNo: to\r\n    } as IResendRequest\r\n    return this.mutator ? this.mutator(this.description, MsgType.ResendRequest, o) : o\r\n  }\r\n\r\n  public sequenceReset (newSeqNo: number): ILooseObject {\r\n    const o: ISequenceReset = {\r\n      GapFillFlag: true,\r\n      NewSeqNo: newSeqNo\r\n    } as ISequenceReset\r\n    return this.mutator ? this.mutator(this.description, MsgType.SequenceReset, o) : o\r\n  }\r\n\r\n  public header (msgType: string, seqNum: number = 0, time: Date = new Date()): ILooseObject {\r\n    if (this.isAscii) {\r\n      return this.asciiHeader(msgType, seqNum, time)\r\n    } else {\r\n      return this.fixmlHeader()\r\n    }\r\n  }\r\n\r\n  public trailer (checksum: number): ILooseObject {\r\n    let width = 3 - checksum.toString().length;\r\n    let ret = ''\r\n    if (width > 0) ret = new Array(width + (/\\./.test(checksum.toString()) ? 2 : 1)).join('0') + checksum\r\n    else ret = checksum.toString()\r\n    return {\r\n      CheckSum: ret\r\n    } as IStandardTrailer\r\n  }\r\n\r\n  private asciiLogon (): ILooseObject {\r\n    const description = this.description\r\n    const o: ILogon = {\r\n      Username: description.Username,\r\n      Password: description.Password,\r\n      HeartBtInt: description.HeartBtInt,\r\n      ResetSeqNumFlag: description.ResetSeqNumFlag,\r\n      EncryptMethod: EncryptMethod.None\r\n    } as ILogon\r\n    return this.mutator ? this.mutator(this.description, MsgType.Logon, o) : o\r\n  }\r\n\r\n  private asciiLogout (text: string): ILooseObject {\r\n    const o: ILogout = {\r\n      Text:  text\r\n    } as ILogout\r\n    return this.mutator ? this.mutator(this.description, MsgType.Logout, o) : o\r\n  }\r\n\r\n  private fixmlLogon (userRequestId: string, isResponse: boolean): ILooseObject {\r\n    const description = this.description\r\n    if (!isResponse) {\r\n      const o: IUserRequest = {\r\n        Username: description.Username,\r\n        Password: description.Password,\r\n        UserRequestID: userRequestId,\r\n        UserRequestType: UserRequestType.LogOnUser\r\n      } as IUserRequest\r\n      return this.mutator ? this.mutator(this.description, MsgType.Logon, o) : o\r\n    } else {\r\n      const o: IUserResponse = {\r\n        Username: description.Username,\r\n        UserRequestID: userRequestId,\r\n        UserStatus: UserStatus.LoggedIn\r\n      } as IUserResponse\r\n      return this.mutator ? this.mutator(this.description, MsgType.Logon, o) : o\r\n    }\r\n  }\r\n\r\n  private fixmlLogout (userRequestId: string, isResponse: boolean): ILooseObject {\r\n    if (!isResponse) {\r\n      const o: IUserRequest = {\r\n        Username: this.description.Username,\r\n        UserRequestID: userRequestId,\r\n        UserRequestType: UserRequestType.LogOffUser\r\n      } as IUserRequest\r\n      return this.mutator ? this.mutator(this.description, MsgType.Logon, o) : o\r\n    } else {\r\n      const o: IUserResponse = {\r\n        Username: this.description.Username,\r\n        UserRequestID: userRequestId,\r\n        UserStatus: UserStatus.NotLoggedIn\r\n      } as IUserResponse\r\n      return this.mutator ? this.mutator(this.description, MsgType.Logon, o) : o\r\n    }\r\n  }\r\n\r\n  private asciiHeader (msgType: string, seqNum: number, time: Date): ILooseObject {\r\n    const description = this.description\r\n    const o: IStandardHeader = {\r\n      BeginString: description.BeginString,\r\n      BodyLength: 9999999,\r\n      MsgType: msgType,\r\n      SenderCompID: description.SenderCompId,\r\n      MsgSeqNum: seqNum,\r\n      SendingTime: time,\r\n      TargetCompID: description.TargetCompID,\r\n      TargetSubID: description.TargetSubID\r\n    }\r\n    return this.mutator ? this.mutator(description, 'StandardHeader', o) : o\r\n  }\r\n\r\n  private fixmlHeader (): ILooseObject {\r\n    const description = this.description\r\n    const o: IStandardHeaderFixml = {\r\n      SenderCompID: description.SenderCompId,\r\n      TargetCompID: description.TargetCompID,\r\n      SenderSubID: description.SenderSubID,\r\n      TargetSubID: description.TargetSubID\r\n    } as IStandardHeaderFixml\r\n    return this.mutator ? this.mutator(this.description, MsgType.Logon, o) : o\r\n  }\r\n}\r\n"]}